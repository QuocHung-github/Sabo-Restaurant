<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SaBo Restaurant | Trang nhà hàng</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" th:href="@{/dist/bootstrap-4.5.2/css/bootstrap.min.css}" />
	<!-- Theme style -->
	<link rel="stylesheet" th:href="@{/css/adminlte.min.css}">
	<link rel="stylesheet" th:href="@{/dist/DataTables/DataTables-1.10.21/css/dataTables.bootstrap4.min.css}">
	<base href="/" />
</head>

<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<!-- Preloader -->
		<div class="preloader flex-column justify-content-center align-items-center">
			<img class="animation__shake" src="/dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
		</div>

		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-white navbar-light">
			<!-- Left navbar links -->
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
			</ul>

			<!-- Right navbar links -->
			<ul class="navbar-nav ml-auto">
				<!-- Messages Dropdown Menu -->
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">3</span>
					</a>
					<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user1-128x128.jpg" alt="User Avatar"
									class="img-size-50 mr-3 img-circle">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										KrisHung
										<span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">Kiểm tra đơn hàng XYZ</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user8-128x128.jpg" alt="User Avatar"
									class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Danh
										<span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">Đơn hàng đã thanh toán</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user3-128x128.jpg" alt="User Avatar"
									class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Nhà Hàng
										<span class="float-right text-sm text-warning"><i
												class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">thay đỗi địa chỉ</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item dropdown-footer">Đánh dấu đã xem</a>
					</div>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="fullscreen" href="#" role="button">
						<i class="fas fa-expand-arrows-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<form id="logoutForm" method="POST" th:action="@{/logout}">
						<input type="hidden" th:if="${_csrf}" name="${_csrf.parameterName}" value="${_csrf.token}" />
						<button type="submit" class="btn btn-primary">Đăng xuất</button>
					</form>
				</li>
			</ul>
		</nav>
		<!-- /.navbar -->

		<!-- Main Sidebar Container -->
		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<!-- Brand Logo -->
			<a href="/merchant/index" class="brand-link">
				<img src="/dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
					style="opacity: .8">
				<input type="hidden" id="restaurantId" />
				<span class="brand-text font-weight-light" id="restaurantBrand"></span>
			</a>

			<!-- Sidebar -->
			<div class="sidebar">

				<!-- Sidebar Menu -->
				<nav class="mt-2">
					<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
						data-accordion="false">
						<!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
						<li class="nav-item">
						<li class="nav-item">
							<a href="/merchant/index" class="nav-link">
								<i class="nav-icon fas fa-file-invoice"></i>
								<p>
									Trang chủ
								</p>
							</a>
						</li>
						<li class="nav-item">
							<a href="/merchant/manage" class="nav-link active">
								<i class="nav-icon fas fa-edit"></i>
								<p>
									Thay đổi thực đơn
								</p>
							</a>
						</li>
						<li class="nav-item">
							<a style="cursor: pointer;" class="nav-link">
								<i class="nav-icon fas fa-chart-pie"></i>
								<p>
									Thống kê
									<i class="right fas fa-angle-left"></i>
								</p>
							</a>
							<ul class="nav nav-treeview">
								<li class="nav-item">
									<a href="/merchant/stats" class="nav-link">
										<i class="far fa-circle nav-icon"></i>
										<p>Đơn hàng</p>
									</a>
								</li>
							</ul>
						</li>
						</li>
					</ul>
				</nav>
				<!-- /.sidebar-menu -->
			</div>
			<!-- /.sidebar -->
		</aside>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>Menu</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Trang chủ</a></li>
								<li class="breadcrumb-item active">Menu</li>
							</ol>
						</div>
					</div>
				</div>
				<!-- /.container-fluid -->
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">


							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Thông tin các móm ăn</h3>
								</div>
								<!-- /.card-header -->
								<div class="card-body">
									<table id="menu" class="table table-bordered table-striped" style="width: 100%;">

									</table>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
			</section>

			<!-- /.content -->
		</div>
		<!-- /.content-wrapper -->
		<footer class="main-footer">
			<strong>Copyright &copy; 2020-2021 <a href="https://www.facebook.com/dinhquochung.quochung">Kris
					Hung</a>.</strong>
			All rights reserved.
			<div class="float-right d-none d-sm-inline-block">
				<b>Version</b> 1.0.0
			</div>
		</footer>

		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	<!-- ./wrapper -->

	<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
	<script th:src="@{/dist/bootstrap-4.5.2/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/webjars/momentjs/min/moment.min.js}"></script>
	<!-- AdminLTE App -->
	<script th:src="@{/js/adminlte.min.js}"></script>
	<script th:src="@{/dist/DataTables/DataTables-1.10.21/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/dist/DataTables/DataTables-1.10.21/js/dataTables.bootstrap4.min.js}"></script>
	<script th:src="@{/dist/DataTables/Buttons-1.6.3/js/dataTables.buttons.min.js}"></script>
	<script th:src="@{/dist/DataTables/Buttons-1.6.3/js/buttons.bootstrap4.min.js}"></script>
	<script th:src="@{/webjars/sweetalert2/dist/sweetalert2.all.min.js}"></script>
	<script th:src="@{/webjars/font-awesome/js/all.min.js}"></script>
	<!-- Page specific script -->
	<script>
		$(document).ready(function () {
			$.ajax({
				url: `/merchant/user`,
				type: "POST",
				contentType: "application/json",
				cache: false,
				headers: {
					"accept": "application/json",
					"Access-Control-Allow-Origin": "*"
				},
				processData: false,
				beforeSend: function (xhr, settings) {
					if (typeof CSRFToken === "string")
						xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
				},
				success: function (data, statusText, jqXHR) {
					$("#restaurantBrand").text(data.restaurant.restaurantName);
					$("#restaurantId").val(data.restaurant.id);
				},
				statusCode: {
					401: function (response) {
						window.location.replace("/login?status=401");
					},
					404: function (response) {
						alert("Không tìm thấy nhà hàng");
					},
					500: function (response) {
						alert("Đã xảy ra sự cố. Xin vui lòng thử lại");
					}
				}
			});

			let table = $('#menu').DataTable({
				dom: "<'clearfix'<'float-left align-middle mr-4'l>B<'float-right align-middle'f>>tr<'clearfix'<'float-left'i><'float-right'p>>",
				buttons: [
					{
						name: "addBtn",
						className: 'btn-primary',
						titleAttr: function (api) {
							return "Thêm";
						},
						text: function (api) {
							return '<i class="fas fa-user-plus"></i> Thêm';
						},
						action: function (e, api, node, config) {
							addMenu(api);
						},
						init: function (api, node, config) {
							$(node).removeClass('btn-secondary')
						}
					}
				],
				pagingType: "full_numbers",
				autoWidth: true,
				orderCellsTop: true,
				autoWidth: true,
				fixedColumns: true,
				language: datatablesLanguage("vi-VN"),
				order: [0, 'asc'],
				rowId: "id",
				columns: [{
					data: null,
					name: null,
					className: "text-center",
					title: "STT",
					render: function (data, type, row, meta) {
						return meta.row + 1;
					}
				}, {
					data: "name",
					name: "name",
					className: "text-center",
					title: "Tên",
					render: $.fn.dataTable.render.text()
				}, {
					data: "type.type",
					name: "type",
					className: "text-center",
					title: "Loại",
					render: $.fn.dataTable.render.text()
				}, {
					data: "price",
					name: "price",
					className: "text-center",
					title: "Giá",
					render: function (data, type, row, meta) {
						return `${numberWithCommas(data)} VNĐ`;
					}
				}, {
					data: null,
					name: null,
					className: "text-center",
					title: "Thao tác",
					render: function (data, type, row, meta) {
						return `<button class="btn btn-success"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger"><i class="fas fa-trash-alt"></i></button>`;
					}
				}],
				ajax: {
					url: `/merchant/menu`,
					type: "GET",
					contentType: "application/json",
					cache: false,
					dataSrc: '',
					headers: {
						"accept": "application/json",
						"Access-Control-Allow-Origin": "*"
					},
					beforeSend: function (xhr, settings) {
						if (typeof CSRFToken === "string")
							xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
					}
				},
				rowCallback: function (row, data) {
					let api = this.api();

					$(row).find("td:last-child button:first-child").on("click", function () {
						editMenu(data, api);
					});

					$(row).find("td:last-child button:last-child").on("click", function () {
						deleteMenu(data, api);
					});
				}
			});

			function numberWithCommas(x) {
				return x.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
			}

			function addMenu(api) {
				Swal.fire({
					icon: "info",
					title: 'Thêm món',
					html: `<div class="card-body">
                                        <div class="form-group">
                                            <label for="name">Tên món</label>
                                            <input type="email" class="form-control" id="name" name="name">
                                        </div>
                                        <div class="form-group">
                                                <label>Loại món</label>
                                                <select class="form-control" id="type" name="type">
                                                <option value="1">Khai vị</option>
                                                <option value="2">Món chính</option>
                                                <option value="3">Đồ uống</option>
                                              </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="price">Giá</label>
                                            <input type="number" min="0" step="1000" class="form-control" id="price" name="price">
                                        </div>
                                    </div>`,
					buttonsStyling: true,
					showConfirmButton: true,
					confirmButtonText: "Thêm",
					showLoaderOnConfirm: true,
					showCancelButton: true,
					cancelButtonText: "Hủy",
					focusConfirm: true,
					allowOutsideClick: () => !Swal.isLoading(),
					preConfirm: () => {
						const name = Swal.getPopup().querySelector('#name').value;
						const type = Swal.getPopup().querySelector('#type').value;
						const price = Swal.getPopup().querySelector('#price').value;

						const data = JSON.stringify({
							"restaurant": {
								"id": $("#restaurantId").val()
							},
							"type": {
								"id": type
							},
							"name": name,
							"price": price
						});

						return $.ajax({
							url: "/merchant/menu",
							type: "POST",
							data: data,
							contentType: "application/json",
							cache: false,
							headers: {
								"accept": "application/json",
								"Access-Control-Allow-Origin": "*"
							},
							processData: false,
							beforeSend: function (xhr, settings) {
								if (typeof CSRFToken === "string")
									xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
							},
							success: function (data, statusText, jqXHR) {
								Swal.fire(
									'Thông báo',
									'Đã thêm món thành công!',
									'success'
								).then(() => {
									api.ajax.reload(null, false);
								});
							},
							statusCode: {
								401: function (response) {
									window.location.replace("/login?status=401");
								},
								404: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, không tìm thấy đường dẫn này`
									)
								},
								500: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, đã xảy ra sự cố hệ thống`
									)
								}
							}
						});
					}
				});
			}

			function editMenu(food, api) {
				Swal.fire({
					icon: "info",
					title: 'Sửa món',
					html: `<div class="card-body">
                                      <input type="hidden" class="form-control" id="id" name="id" value="${food.id}">
                                        <div class="form-group">
                                            <label for="name">Tên</label>
                                            <input type="email" class="form-control" id="name" name="name" value="${food.name}">
                                        </div>
                                        <div class="form-group">
                                                <label>Loại món</label>
                                                <select class="form-control" id="type" name="type">
                                                <option value="1" ${food.type.id === 1 ? "selected" : ""}>Khai vị</option>
                                                <option value="2" ${food.type.id === 2 ? "selected" : ""}>Món chính</option>
                                                <option value="3" ${food.type.id === 3 ? "selected" : ""}>Đồ uống</option>
                                              </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="price">Giá</label>
                                            <input type="number" min="0" step="1000" class="form-control" id="price" name="price" value="${food.price}">
                                        </div>
                                    </div>`,
					buttonsStyling: false,
					customClass: {
						"confirmButton": "btn btn-success mr-1",
						"cancelButton": "btn btn-secondary"
					},
					showConfirmButton: true,
					confirmButtonText: "Sửa",
					showLoaderOnConfirm: true,
					showCancelButton: true,
					cancelButtonText: "Hủy",
					focusConfirm: true,
					allowOutsideClick: () => !Swal.isLoading(),
					preConfirm: () => {
						const id = Swal.getPopup().querySelector('#id').value;
						const name = Swal.getPopup().querySelector('#name').value;
						const type = Swal.getPopup().querySelector('#type').value;
						const price = Swal.getPopup().querySelector('#price').value;

						const data = JSON.stringify({
							"id": id,
							"restaurant": {
								"id": food.restaurant.id
							},
							"type": {
								"id": type
							},
							"name": name,
							"price": price
						});

						return $.ajax({
							url: "/merchant/menu",
							type: "PUT",
							data: data,
							contentType: "application/json",
							cache: false,
							headers: {
								"accept": "application/json",
								"Access-Control-Allow-Origin": "*"
							},
							processData: false,
							beforeSend: function (xhr, settings) {
								if (typeof CSRFToken === "string")
									xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
							},
							success: function (data, statusText, jqXHR) {
								Swal.fire(
									'Thông báo',
									'Đã cập nhật món thành công!',
									'success'
								).then(() => {
									api.ajax.reload(null, false);
								});
							},
							statusCode: {
								401: function (response) {
									window.location.replace("/login?status=401");
								},
								404: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, không tìm thấy đường dẫn này`
									)
								},
								500: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, đã xảy ra sự cố hệ thống`
									)
								}
							}
						});
					}
				});
			}

			function deleteMenu(food, api) {
				Swal.fire({
					icon: "warning",
					title: 'Xóa món',
					html: `Bạn muốn xóa: ${food.name}`,
					buttonsStyling: false,
					customClass: {
						"confirmButton": "btn btn-danger mr-1",
						"cancelButton": "btn btn-secondary"
					},
					showConfirmButton: true,
					confirmButtonText: "Xóa",
					showLoaderOnConfirm: true,
					showCancelButton: true,
					cancelButtonText: "Hủy",
					focusConfirm: true,
					allowOutsideClick: () => !Swal.isLoading(),
					preConfirm: () => {

						return $.ajax({
							url: "/merchant/menu",
							type: "DELETE",
							data: JSON.stringify(food),
							contentType: "application/json",
							cache: false,
							headers: {
								"accept": "application/json",
								"Access-Control-Allow-Origin": "*"
							},
							processData: false,
							beforeSend: function (xhr, settings) {
								if (typeof CSRFToken === "string")
									xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
							},
							success: function (data, statusText, jqXHR) {
								Swal.fire(
									'Thông báo',
									'Đã xóa món thành công!',
									'success'
								).then(() => {
									api.ajax.reload(null, false);
								});
							},
							statusCode: {
								401: function (response) {
									window.location.replace("/login?status=401");
								},
								404: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, không tìm thấy đường dẫn này`
									)
								},
								500: function (response) {
									Swal.showValidationMessage(
										`Xin lỗi, đã xảy ra sự cố hệ thống`
									)
								}
							}
						});
					}
				});
			}

			function datatablesLanguage(lang) {
				if (lang === "vi-VN") {
					return {
						decimal: ".",
						emptyTable: "Bảng hiện không có dữ liệu",
						info: "Hiển thị từ _START_ đến _END_ mục trong tổng số _TOTAL_ mục",
						infoEmpty: "Không có dữ liệu",
						infoFiltered: "(Đã lọc trong tổng số _MAX_ mục)",
						infoPostFix: "",
						thousands: ",",
						lengthMenu: "Hiện _MENU_ mục",
						loadingRecords: "Đang tải...",
						processing: "Đang xử lý...",
						search: "Tìm kiếm:",
						zeroRecords: "Không có kết quả mà bạn cần tìm",
						paginate: {
							first: "Đầu",
							last: "Cuối",
							next: "Tiếp",
							previous: "Trước"
						},
						aria: {
							sortAscending: ": Sắp xếp cột theo thứ tự tăng dần",
							sortDescending: ": Sắp xếp cột theo thứ tự giảm dần"
						},
						select: {
							rows: {
								_: "%d mục đã được chọn",
								0: "Chưa mục nào được chọn"
							}
						}
					};
				} else if (lang === "en-US") {
					return {
						decimal: "",
						emptyTable: "No data available in table",
						info: "Showing _START_ to _END_ of _TOTAL_ entries",
						infoEmpty: "Showing 0 to 0 of 0 entries",
						infoFiltered: "(filtered from _MAX_ total entries)",
						infoPostFix: "",
						thousands: ",",
						lengthMenu: "Show _MENU_ entries",
						loadingRecords: "Loading...",
						processing: "Processing...",
						search: "Search:",
						zeroRecords: "No matching records found",
						paginate: {
							first: "First",
							last: "Last",
							next: "Next",
							previous: "Previous"
						},
						aria: {
							sortAscending: ": activate to sort column ascending",
							sortDescending: ": activate to sort column descending"
						},
						select: {
							rows: {
								_: "%d entries selected",
								0: "No entry selected",
								1: "1 entry selected"
							}
						}
					};
				} else {
					return {};
				}
			}
		});
	</script>
</body>

</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SaBo Restaurant | Trang cá nhân</title>

	<!-- Google Font: Source Sans Pro -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<!-- Font Awesome -->
	<link rel="stylesheet" th:href="@{/webjars/font-awesome/css/font-awesome.min.css}">
	<link rel="stylesheet" th:href="@{/dist/bootstrap-4.5.2/css/bootstrap.min.css}" />
	<!-- Theme style -->
	<link rel="stylesheet" th:href="@{/css/adminlte.min.css}">
	<link rel="stylesheet" th:href="@{/dist/DataTables/DataTables-1.10.21/css/dataTables.bootstrap4.min.css}">
	<base href="/" />
</head>

<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">

		<!-- Preloader -->
		<div class="preloader flex-column justify-content-center align-items-center">
			<img class="animation__shake" src="/dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
		</div>

		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-white navbar-light">
			<!-- Left navbar links -->
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
			</ul>

			<!-- Right navbar links -->
			<ul class="navbar-nav ml-auto">
				<!-- Messages Dropdown Menu -->
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">3</span>
					</a>
					<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user1-128x128.jpg" alt="User Avatar"
									class="img-size-50 mr-3 img-circle">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										KrisHung
										<span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">Kiểm tra đơn hàng XYZ</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user8-128x128.jpg" alt="User Avatar"
									class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Danh
										<span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">Đơn hàng đã thanh toán</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item">
							<!-- Message Start -->
							<div class="media">
								<img src="/dist/img/user3-128x128.jpg" alt="User Avatar"
									class="img-size-50 img-circle mr-3">
								<div class="media-body">
									<h3 class="dropdown-item-title">
										Nhà Hàng
										<span class="float-right text-sm text-warning"><i
												class="fas fa-star"></i></span>
									</h3>
									<p class="text-sm">thay đỗi địa chỉ</p>
									<p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
								</div>
							</div>
							<!-- Message End -->
						</a>
						<div class="dropdown-divider"></div>
						<a href="#" class="dropdown-item dropdown-footer">Đánh dấu đã xem</a>
					</div>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="fullscreen" href="#" role="button">
						<i class="fas fa-expand-arrows-alt"></i>
					</a>
				</li>
				<li class="nav-item">
					<form id="logoutForm" method="POST" th:action="@{/logout}">
						<input type="hidden" th:if="${_csrf}" name="${_csrf.parameterName}" value="${_csrf.token}" />
						<button type="submit" class="btn btn-primary">Đăng xuất</button>
					</form>
				</li>
			</ul>
		</nav>
		<!-- /.navbar -->

		<!-- Main Sidebar Container -->
		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<!-- Brand Logo -->
			<a href="/customer/index" class="brand-link">
				<img src="/dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
					style="opacity: .8">
				<span class="brand-text font-weight-light">Thông tin cá nhân</span>
			</a>

			<!-- Sidebar -->
			<div class="sidebar">

				<!-- Sidebar user panel (optional) -->
				<div class="user-panel mt-3 pb-3 mb-3 d-flex">
					<div class="image">
						<img src="/dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
					</div>
					<div class="info">
						<a style="cursor: pointer;" id="greeting" class="d-block"></a>
					</div>
				</div>
				<!-- Sidebar Menu -->
				<nav class="mt-2">
					<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
						data-accordion="false">
						<!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
						<li class="nav-item">
							<a style="cursor: pointer;" class="nav-link active">
								<i class="nav-icon fas fa-history"></i>
								<p>
									Lịch sử đơn hàng
								</p>
							</a>
						</li>
					</ul>
				</nav>
		</aside>
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>Thông tin khách hàng</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Trang chủ</a></li>
								<li class="breadcrumb-item active">Thông tin khách hàng</li>
							</ol>
						</div>
					</div>
				</div><!-- /.container-fluid -->
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Lịch sử đặt bàn</h3>
								</div>
								<!-- /.card-header -->
								<div class="card-body">
									<table id="history" class="table table-bordered table-striped" style="width: 100%;">

									</table>
								</div>
								<!-- /.card-body -->
							</div>
							<!-- /.card -->
						</div>
						<!-- /.col -->
					</div>
					<!-- /.row -->
				</div>
				<!-- /.container-fluid -->
			</section>
			<footer class="main-footer">
				<strong>Copyright &copy; 2020-2021 <a href="https://www.facebook.com/dinhquochung.quochung">Kris
						Hung</a>.</strong>
				All rights reserved.
				<div class="float-right d-none d-sm-inline-block">
					<b>Version</b> 1.0.0
				</div>
			</footer>

			<!-- Control Sidebar -->
			<aside class="control-sidebar control-sidebar-dark">
				<!-- Control sidebar content goes here -->
			</aside>
			<!-- /.control-sidebar -->
		</div>
		<!-- ./wrapper -->

		<!-- jQuery -->
		<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
		<!-- Bootstrap 4 -->
		<script th:src="@{/dist/bootstrap-4.5.2/js/bootstrap.bundle.min.js}"></script>
		<!-- daterangepicker -->
		<script th:src="@{/webjars/momentjs/min/moment.min.js}"></script>
		<!-- AdminLTE App -->
		<script th:src="@{/js/adminlte.min.js}"></script>
		<script th:src="@{/dist/DataTables/DataTables-1.10.21/js/jquery.dataTables.min.js}"></script>
		<script th:src="@{/dist/DataTables/DataTables-1.10.21/js/dataTables.bootstrap4.min.js}"></script>
		<script th:src="@{/webjars/sweetalert2/dist/sweetalert2.all.min.js}"></script>
		<script th:src="@{/webjars/font-awesome/js/all.min.js}"></script>
</body>
<script>
	$(document).ready(function () {
		$.ajax({
			url: `/customer/user`,
			type: "POST",
			//data: data,
			contentType: "application/json",
			cache: false,
			headers: {
				"accept": "application/json",
				"Access-Control-Allow-Origin": "*"
			},
			processData: false,
			beforeSend: function (xhr, settings) {
				if (typeof CSRFToken === "string")
					xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
			},
			success: function (data, statusText, jqXHR) {
				$("#greeting").text(`${data.lastName} ${data.firstName}`);

				$("#greeting").on("click", function () {
					Swal.fire({
						icon: 'info',
						title: 'Cập nhật thông tin tài khoản',
						html: `<div class="card-body">
										<div class="form-group">
                                            <input type="hidden" class="form-control" name="custId" id="custId" value="${data.id}"/>
                                        </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="username">Tài khoản</label>
                                            <input type="text" class="form-control" name="username" id="username" value="${data.account.username}"/>
                                        </div>
                                        <div class="form-group">
                                            <input type="hidden" class="form-control" name="oldUsername" id="oldUsername" value="${data.account.username}"/>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="password">Mật khẩu</label>
                                            <input type="password" class="form-control" name="password" id="password"/>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="lastName">Họ</label>
                                            <input type="text" class="form-control" name="lastName" id="lastName" value="${data.lastName}"/>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="firstName">Tên</label>
                                            <input type="text" class="form-control" name="firstName" id="firstName" value="${data.firstName}"/>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="gender">Giới tính</label>
                                            <select name="gender" id="gender" class="form-control">
                                                <option value="1" ${data.gender === 1 ? "selected" : ""}>Nam</option>
                                                <option value="0" ${data.gender === 0 ? "selected" : ""}>Nữ</option>
                                                <option value="2" ${data.gender === 2 ? "selected" : ""}>Khác</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="birthday">Ngày sinh</label>
                                            <input type="date" class="form-control" name="birthday" id="birthday" value="${data.birthday}">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="email">Email</label>
                                            <input type="email" class="form-control" name="email" id="email" value="${data.email}">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="phone">Số điện thoại</label>
                                            <input type="tel" class="form-control" name="phone" id="phone" value="${data.phone}" placeholder="090xxxxxxx" pattern="^(0?)(3[2-9]|5[6|8|9]|7[0|6-9]|8[0-6|8|9]|9[0-4|6-9])[0-9]{7}$">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="address">Địa chỉ</label>
                                        <textarea class="form-control" name="address" id="address" rows="3">${data.address}</textarea>
                                    </div>
                                </div>`,
						showConfirmButton: true,
						confirmButtonText: "Cập nhật",
						showLoaderOnConfirm: true,
						showCancelButton: true,
						cancelButtonText: "Hủy bỏ",
						focusConfirm: true,
						allowOutsideClick: () => !Swal.isLoading(),
						preConfirm: () => {
							//if (!data.bookingDate) {
							//Swal.showValidationMessage("Vui lòng chọn thời gian đặt bàn");
							//return false;
							//}
							let data = {
								"id": Swal.getPopup().querySelector('#custId').value,
								"firstName": Swal.getPopup().querySelector('#firstName').value ? Swal.getPopup().querySelector('#firstName').value : "",
								"lastName": Swal.getPopup().querySelector('#lastName').value ? Swal.getPopup().querySelector('#lastName').value : "",
								"birthday": Swal.getPopup().querySelector('#birthday').value ? Swal.getPopup().querySelector('#birthday').value : "",
								"gender": Swal.getPopup().querySelector('#gender').value ? Swal.getPopup().querySelector('#gender').value : "",
								"email": Swal.getPopup().querySelector('#email').value ? Swal.getPopup().querySelector('#email').value : "",
								"phone": Swal.getPopup().querySelector('#phone').value ? Swal.getPopup().querySelector('#phone').value : "",
								"address": Swal.getPopup().querySelector('#address').value ? Swal.getPopup().querySelector('#address').value : "",
								"account": {
									"username": Swal.getPopup().querySelector('#username').value ? Swal.getPopup().querySelector('#username').value : "",
									"password": Swal.getPopup().querySelector('#password').value ? Swal.getPopup().querySelector('#password').value : "",
									"active": true
								},
								"role": {
									"id": 3
								}
							};

							return $.ajax({
								url: "/customer/updateInfo",
								type: "PUT",
								data: JSON.stringify(data),
								contentType: "application/json",
								cache: false,
								headers: {
									"accept": "application/json",
									"Access-Control-Allow-Origin": "*"
								},
								processData: false,
								beforeSend: function (xhr, settings) {
									if (typeof CSRFToken === "string")
										xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
								},
								success: function (data, statusText, jqXHR) {
									let logout = false;

									if (Swal.getPopup().querySelector('#username').value != Swal.getPopup().querySelector('#oldUsername').value || Swal.getPopup().querySelector('#password').value)
										logout = true;
									//return {logout: true}
									//return {logout: false};

									Swal.fire(
										'Thông báo',
										'Cập nhật thông tin thành công!',
										'success'
									).then(() => {
										if (logout) $("#logoutForm").submit();
										else location.reload();
									});
								},
								statusCode: {
									401: function (response) {
										window.location.replace("/login?status=401");
									},
									404: function (response) {
										Swal.showValidationMessage(
											`Xin lỗi, ${response}`
										)
									},
									500: function (response) {
										Swal.showValidationMessage(
											`Xin lỗi, đã xảy ra sự cố hệ thống`
										)
									}
								}
							}).catch(function (error) {
								Swal.showValidationMessage(
									`Xin lỗi, đã xảy ra sự cố hệ thống`
								)
							});
						}
					});
					//.then((response) => {
					//if (response.isConfirmed) {

					//}
					//});
				});
			},
			statusCode: {
				401: function (response) {
					window.location.replace("/login?status=401");
				},
				404: function (response) {
					alert("Không tìm thấy khách hàng");
				},
				500: function (response) {
					alert("Đã xảy ra sự cố. Xin vui lòng thử lại");
				}
			}
		});

		$('#history').DataTable({
			pagingType: "full_numbers",
			autoWidth: true,
			orderCellsTop: true,
			responsive: false,
			autoWidth: true,
			fixedColumns: true,
			order: [0, 'asc'],
			language: datatablesLanguage("vi-VN"),
			columns: [{
				data: null,
				name: null,
				className: "text-center",
				title: "STT",
				render: function (data, type, row, meta) {
					return meta.row + 1;
				}
			}, {
				data: "restaurant.restaurantName",
				name: "restaurant.restaurantName",
				className: "text-center",
				title: "Nhà hàng",
				render: $.fn.dataTable.render.text()
			}, {
				data: "createdDate",
				name: "createdDate",
				className: "text-center",
				title: "Ngày tạo đơn",
				render: function (data, type, row, meta) {
					return moment(data).format('DD/MM/YYYY - h:mm:ss A');
				}
			}, {
				data: "bookingDate",
				name: "bookingDate",
				className: "text-center",
				title: "Ngày đặt",
				render: function (data, type, row, meta) {
					return moment(data).format('DD/MM/YYYY - h:mm:ss A');
				}
			}, {
				data: "persons",
				name: "persons",
				className: "text-center",
				title: "Số người",
				render: $.fn.dataTable.render.text()
			}, {
				data: "status",
				name: "status",
				className: "text-center",
				title: "Trạng thái",
				render: function (data, type, row, meta) {
					switch (data) {
						case 0:
							return "Đã tạo"
						case 1:
							return "Đã xác nhận"
						case 2:
							return "Chờ xác nhận"
						default:
							return "N/A"
					}
				}
			}],
			ajax: {
				url: '/customer/history',
				type: "POST",
				contentType: "application/json",
				cache: false,
				dataSrc: '',
				headers: {
					"accept": "application/json",
					"Access-Control-Allow-Origin": "*"
				},
				beforeSend: function (xhr, settings) {
					if (typeof CSRFToken === "string")
						xhr.setRequestHeader('X-CSRF-Token', CSRFToken);
				}
			},
			rowCallback: function (row, data) {
				let api = this.api();


			}
		});
		//.on('order.dt search.dt', function (e, settings) {
		//let api = new $.fn.dataTable.Api( settings );

		//api.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
		//cell.innerHTML = i + 1;
		//});
		//}).draw();

		function datatablesLanguage(lang) {
			if (lang === "vi-VN") {
				return {
					decimal: ".",
					emptyTable: "Bảng hiện không có dữ liệu",
					info: "Hiển thị từ _START_ đến _END_ mục trong tổng số _TOTAL_ mục",
					infoEmpty: "Không có dữ liệu",
					infoFiltered: "(Đã lọc trong tổng số _MAX_ mục)",
					infoPostFix: "",
					thousands: ",",
					lengthMenu: "Hiện _MENU_ mục",
					loadingRecords: "Đang tải...",
					processing: "Đang xử lý...",
					search: "Tìm kiếm:",
					zeroRecords: "Không có kết quả mà bạn cần tìm",
					paginate: {
						first: "Đầu",
						last: "Cuối",
						next: "Tiếp",
						previous: "Trước"
					},
					aria: {
						sortAscending: ": Sắp xếp cột theo thứ tự tăng dần",
						sortDescending: ": Sắp xếp cột theo thứ tự giảm dần"
					},
					select: {
						rows: {
							_: "%d mục đã được chọn",
							0: "Chưa mục nào được chọn"
						}
					}
				};
			} else if (lang === "en-US") {
				return {
					decimal: "",
					emptyTable: "No data available in table",
					info: "Showing _START_ to _END_ of _TOTAL_ entries",
					infoEmpty: "Showing 0 to 0 of 0 entries",
					infoFiltered: "(filtered from _MAX_ total entries)",
					infoPostFix: "",
					thousands: ",",
					lengthMenu: "Show _MENU_ entries",
					loadingRecords: "Loading...",
					processing: "Processing...",
					search: "Search:",
					zeroRecords: "No matching records found",
					paginate: {
						first: "First",
						last: "Last",
						next: "Next",
						previous: "Previous"
					},
					aria: {
						sortAscending: ": activate to sort column ascending",
						sortDescending: ": activate to sort column descending"
					},
					select: {
						rows: {
							_: "%d entries selected",
							0: "No entry selected",
							1: "1 entry selected"
						}
					}
				};
			} else {
				return {};
			}
		}
	});
</script>

</html>